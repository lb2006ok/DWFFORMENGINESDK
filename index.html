<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>dwfformenginesdk</title>
    <!-- 配置对象 -->
    <script>
      var ip = location.host;
      var protocol = location.protocol;
      var port = location.port;
      port = !port || port == '' ? 80 : port;
      var idx = ip.indexOf(":");
      ip = idx == -1 ? ip : ip.substring(0, idx);

      // 全局配置
      window.Config = {
        modelerApiBase: `http://172.21.11.85:6060`,
        appApiBase: `http://172.21.11.85:9090`,
        monitorApiBase: `http://172.21.11.85:7070`,
        modelerWSBaseUrl: `ws://${ip}:6060`,
        appWSBaseUrl: `ws://${ip}:9090`,
        monitorWSBaseUrl: `ws://${ip}:7070`,
        tomcatUrl: `http://172.21.11.85:6060:${port}`,
        debuggerScriptPort: '4242',
        formCacheOpen: true,
        formCacheTimeoutBySecond: 864000,
        isolatedNetwork: false,
        baiduMapKey: '7dlPh6TyYSbm5RrUulF4JRfNfO5qnr13',
        AgGridKey: 'Using_this_{AG_Grid}_Enterprise_key_{AG-080625}_in_excess_of_the_licence_granted_is_not_permitted___Please_report_misuse_to_legal@ag-grid.com___For_help_with_changing_this_key_please_contact_info@ag-grid.com___{Tsinghua_University_Publishing_House}_is_granted_a_{Multiple_Applications}_Developer_License_for_{1}_Front-End_JavaScript_developer___All_Front-End_JavaScript_developers_need_to_be_licensed_in_addition_to_the_ones_working_with_{AG_Grid}_Enterprise___This_key_has_not_been_granted_a_Deployment_License_Add-on___This_key_works_with_{AG_Grid}_Enterprise_versions_released_before_{5_December_2026}____[v3]_[01]_MTc5NjQyODgwMDAwMA==c2e0fab3e00c23637f6cd3e9c28245f0',
        aesKeyA: 'gJBd2z7fJ!C0^e3T',
        aesKeyB: 'vndKmU#KbOxpifI0',
        aesIv: 'KPXUGHNBRWLYKRTE',
        baseModelerRouteName: 'modeler-web',
        baseAppRouteName: 'app-web',
        protocol: protocol,
        ip: ip,
        ModelerPort: '8180'
      }
    </script>

    <!-- SDK样式 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lb2006ok/DWFFORMENGINESDK@master/lib/style.css">
    <!-- SDK脚本 -->
    <script src="https://cdn.jsdelivr.net/gh/lb2006ok/DWFFORMENGINESDK@master/lib/dwf-form-engine.umd.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html, body {
        height: 100%;
        overflow: hidden;
      }

      .controls button {
        margin: 5px;
        padding: 8px 16px;
        border: 1px solid #dcdfe6;
        border-radius: 4px;
        background: #fff;
        cursor: pointer;
      }

      .controls button:hover {
        background: #f5f7fa;
      }

      .controls button.primary {
        background: #409eff;
        color: white;
        border-color: #409eff;
      }

      .controls button.primary:hover {
        background: #66b1ff;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="loading">正在加载表单引擎...</div>
    </div>
    <script type="module" src="/src/main.ts"></script>
    <script>
      // ============================================
      // SDK配置
      // ============================================
      const SDK_CONFIG = {
        token: 'eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiIzRTlBNkQyRkVBMDk4MzRGOEUyQzMwODM1REVBREVDNSIsImV4cCI6MTc3Mjk1NjQ4N30.KUd6adQC5SBWpdlzzRUR4dA2eT5bKohs7nHnxzYupcgxHRdcykY8AwxvDVXF_0i0hnsWdVYEgyvPnJqFOn5ACQ',
        path: '/forms/Part/selectForm',
        query: {
          displayType: 'edit'
        },
        debug: true
      };

      // ============================================
      // 创建SDK实例
      // ============================================
      let sdkInstance = null;
      const sdk = new DWFFORMENGINE(SDK_CONFIG);

      // ============================================
      // 生命周期事件监听
      // ============================================

      // SDK 初始化事件
      sdk.on('sdk:init', function(event) {
        console.log('[SDK生命周期] SDK初始化', event);
      });

      sdk.on('sdk:ready', function(event) {
        console.log('[SDK生命周期] SDK就绪', event);
        sdkInstance = event.instance || sdk;
      });

      sdk.on('sdk:mounted', function(event) {
        console.log('[SDK生命周期] SDK已挂载', event);
      });

      sdk.on('sdk:unmounted', function(event) {
        console.log('[SDK生命周期] SDK已卸载', event);
        sdkInstance = null;
      });

      sdk.on('sdk:error', function(event) {
        console.error('[SDK生命周期] SDK错误', event);
      });

      // ============================================
      // 表单生命周期事件监听
      // ============================================

      // 表单创建
      sdk.on('form:created', function(event) {
        console.log('[表单生命周期] 表单已创建', event);
        console.log('  - 表单实例:', event.instance);
      });

      // 表单挂载
      sdk.on('form:mounted', function(event) {
        console.log('[表单生命周期] 表单已挂载', event);
        console.log('  - 表单实例:', event.instance);
        console.log('  - 加载时间:', event.loadTime);
      });

      // 表单加载完成
      sdk.on('form:loaded', function(event) {
        console.log('[表单生命周期] 表单数据加载完成', event);
        console.log('  - 目标类:', event.targetClass);
        console.log('  - 视图名:', event.viewName);
      });

      // 表单卸载
      sdk.on('form:unmounted', function(event) {
        console.log('[表单生命周期] 表单已卸载', event);
      });

      // 表单重置
      sdk.on('form:reset', function(event) {
        console.log('[表单生命周期] 表单已重置', event);
      });

      // ============================================
      // 验证事件监听
      // ============================================

      // 验证开始前
      sdk.on('validate:before', function(event) {
        console.log('[验证事件] 验证开始', event);
        console.log('  - 验证项:', event.item);
      });

      // 验证完成
      sdk.on('validate:after', function(event) {
        console.log('[验证事件] 验证完成', event);
        console.log('  - 验证结果:', event.valid);
        console.log('  - 验证数据:', event.data);
      });

      // 验证错误
      sdk.on('validate:error', function(event) {
        console.warn('[验证事件] 验证失败', event);
        console.log('  - 错误信息:', event.errors);
      });

      // ============================================
      // 提交事件监听
      // ============================================

      // 提交开始前
      sdk.on('submit:before', function(event) {
        console.log('[提交事件] 提交开始', event);
        console.log('  - 操作类型:', event.action);
        console.log('  - 数据对象:', event.obj);
        console.log('  - 目标类:', event.className);
      });

      // 表单提交中
      sdk.on('form:submitting', function(event) {
        console.log('[提交事件] 表单正在提交...', event);
        console.log('  - 操作类型:', event.action);
      });

      // 表单提交成功
      sdk.on('form:submitted', function(event) {
        console.log('[提交事件] 表单提交成功', event);
        console.log('  - 操作类型:', event.action);
        console.log('  - 返回结果:', event.result);
      });

      // 表单提交错误
      sdk.on('form:error', function(event) {
        console.error('[提交事件] 表单提交失败', event);
        console.log('  - 操作类型:', event.action);
        console.log('  - 错误阶段:', event.phase);
        console.log('  - 错误信息:', event.error);
      });

      // ============================================
      // 弹窗事件监听
      // ============================================

      // 弹窗打开
      sdk.on('dialog:opened', function(event) {
        console.log('[弹窗事件] 弹窗已打开', event);
        console.log('  - 目标类:', event.targetClass);
        console.log('  - 视图名:', event.viewName);
        console.log('  - 显示类型:', event.displayType);
      });

      // 弹窗关闭
      sdk.on('dialog:closed', function(event) {
        console.log('[弹窗事件] 弹窗已关闭', event);
        console.log('  - 返回结果:', event.result);
        console.log('  - 类型:', event.type);
      });

      // 弹窗确认
      sdk.on('dialog:confirmed', function(event) {
        console.log('[弹窗事件] 弹窗确认', event);
        console.log('  - 返回结果:', event.result);
      });

      // 弹窗取消
      sdk.on('dialog:canceled', function(event) {
        console.log('[弹窗事件] 弹窗取消', event);
      });

      // ============================================
      // 抽屉事件监听
      // ============================================

      // 抽屉打开
      sdk.on('drawer:opened', function(event) {
        console.log('[抽屉事件] 抽屉已打开', event);
        console.log('  - 目标类:', event.targetClass);
        console.log('  - 视图名:', event.viewName);
        console.log('  - 方向:', event.direction);
      });

      // 抽屉确认
      sdk.on('drawer:confirmed', function(event) {
        console.log('[抽屉事件] 抽屉确认', event);
        console.log('  - 返回结果:', event.result);
      });

      // 抽屉取消
      sdk.on('drawer:canceled', function(event) {
        console.log('[抽屉事件] 抽屉取消', event);
      });

      // ============================================
      // Tab事件监听
      // ============================================

      // Tab打开
      sdk.on('tab:opened', function(event) {
        console.log('[Tab事件] Tab已打开', event);
        console.log('  - Tab信息:', event.tab);
      });

      // Tab确认
      sdk.on('tab:confirmed', function(event) {
        console.log('[Tab事件] Tab确认', event);
        console.log('  - 返回结果:', event.result);
      });

      // ============================================
      // 操作事件监听
      // ============================================

      // 操作执行前
      sdk.on('operation:before', function(event) {
        console.log('[操作事件] 操作即将执行', event);
        console.log('  - 操作名称:', event.operationName);
        console.log('  - 目标类:', event.targetClass);
        console.log('  - 自定义数据:', event.customData);
      });

      // ============================================
      // 数据总线（DataBus）使用示例
      // ============================================

      // 挂载成功后使用数据总线
      sdk.on('sdk:mounted', function(event) {
        const dataBus = sdk.getDataBus();

        if (dataBus) {
          console.log('[数据总线] DataBus已就绪');

          // 监听数据变化
          dataBus.watch('formData', function(newVal, oldVal) {
            console.log('[数据总线] formData变化:', {
              old: oldVal,
              new: newVal
            });
          });

          // 监听验证状态变化
          dataBus.watch('isValid', function(newVal, oldVal) {
            console.log('[数据总线] 验证状态变化:', {
              old: oldVal,
              new: newVal
            });
          });

          // 监听提交状态变化
          dataBus.watch('isSubmitting', function(newVal, oldVal) {
            console.log('[数据总线] 提交状态变化:', {
              old: oldVal,
              new: newVal
            });
          });

          // 设置初始状态
          dataBus.set('customData', {
            initializedAt: new Date().toISOString()
          });

          console.log('[数据总线] 当前状态:', dataBus.getState());
        }
      });

      // 表单加载完成后获取数据
      sdk.on('form:loaded', function(event) {
        const dataBus = sdk.getDataBus();

        if (dataBus) {
          // 获取表单数据
          const formData = dataBus.getFormData();
          console.log('[数据总线] 当前表单数据:', formData);

          // 获取所有状态
          console.log('[数据总线] 完整状态:', dataBus.getState());
        }
      });

      // ============================================
      // SDK方法调用示例
      // ============================================

      // 获取表单数据
      function getFormData() {
        const data = sdk.getFormData();
        console.log('[SDK方法] 获取表单数据:', data);
        return data;
      }

      // 设置表单数据
      function setFormData(data) {
        sdk.setFormData(data);
        console.log('[SDK方法] 设置表单数据:', data);
      }

      // 设置单个字段值
      function setFieldValue(fieldName, value) {
        sdk.setFieldValue(fieldName, value);
        console.log('[SDK方法] 设置字段值:', { fieldName, value });
      }

      // 获取单个字段值
      function getFieldValue(fieldName) {
        const value = sdk.getFieldValue(fieldName);
        console.log('[SDK方法] 获取字段值:', { fieldName, value });
        return value;
      }

      // 验证表单
      async function validateForm() {
        console.log('[SDK方法] 开始验证表单...');
        const result = await sdk.validate();
        console.log('[SDK方法] 验证结果:', result);
        return result;
      }

      // 提交表单
      async function submitForm() {
        console.log('[SDK方法] 开始提交表单...');
        const result = await sdk.submit();
        console.log('[SDK方法] 提交结果:', result);
        return result;
      }

      // 重置表单
      function resetForm() {
        sdk.resetForm();
        console.log('[SDK方法] 表单已重置');
      }

      // 刷新表单
      async function refreshForm() {
        console.log('[SDK方法] 开始刷新表单...');
        await sdk.refresh();
        console.log('[SDK方法] 表单已刷新');
      }

      // 使用链式API
      function chainApiExample() {
        console.log('[SDK方法] 链式API示例:');

        sdk
                .setFormData({ name: '测试数据', code: 'TEST001' })
                .validate()
                .then(function(result) {
                  console.log('  - 验证结果:', result);
                  if (result.valid) {
                    return sdk.submit();
                  }
                  return Promise.reject('验证失败');
                })
                .then(function(result) {
                  console.log('  - 提交结果:', result);
                })
                .catch(function(error) {
                  console.error('  - 错误:', error);
                });
      }

      // ============================================
      // 挂载SDK
      // ============================================
      sdk.mount('#app');

      // ============================================
      // 页面卸载时清理
      // ============================================
      window.addEventListener('beforeunload', function() {
        if (sdkInstance) {
          sdkInstance.unmount();
        }
      });

      // ============================================
      // 全局暴露SDK实例（用于调试）
      // ============================================
      window.DWF_SDK = sdk;
      console.log('[SDK] SDK实例已挂载到 window.DWF_SDK，可在控制台调试使用');
      console.log('[SDK] 可用方法: getFormData, setFormData, setFieldValue, getFieldValue, validate, submit, resetForm, refresh');
      console.log('[SDK] 数据总线: getDataBus()');
      console.log('[SDK] 事件总线: getEventBus()');
    </script>
  </body>
</html>
